<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üí∞ Price Comparer</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #f8fafc; margin: 0; padding: 30px; display: flex; flex-direction: column; align-items: center; }
        h1 { font-size: 32px; color: #1e1e1e; margin-bottom: 10px; }
        p.subtitle { text-align: center; color: #787878; max-width: 650px; margin-bottom: 40px; }
        .drop-container { display: flex; gap: 25px; width: 100%; max-width: 1100px; margin-bottom: 40px; }
        .drop-area { flex: 1; background-color: #ffffff; border: 2px dashed #dee2e6; border-radius: 12px; padding: 30px; text-align: center; position: relative; min-height: 250px; cursor: pointer; transition: all 0.2s; }
        .drop-area.dragover { border-color: #28a745; background-color: #f5f9ff; }
        .drop-area h2 { margin: 0; font-size: 20px; margin-bottom: 10px; }
        .drop-area p { font-size: 14px; color: #787878; }
        .file-list { margin-top: 15px; text-align: left; max-height: 150px; overflow-y: auto; }
        .file-item { background-color: #f5f9ff; border-radius: 6px; padding: 6px 10px; margin-bottom: 6px; font-size: 14px; display: flex; justify-content: space-between; align-items: center; }
        .file-item span.remove { cursor: pointer; color: #ff6b6b; font-weight: bold; }
        .generate-btn { background-color: #28a745; color: white; font-weight: bold; font-size: 16px; border: none; border-radius: 20px; padding: 15px 40px; cursor: pointer; transition: background-color 0.2s; }
        .generate-btn:disabled { background-color: #c8c8c8; cursor: not-allowed; }
        .generate-btn:hover:not(:disabled) { background-color: #218838; }
        .progress-container { width: 100%; max-width: 1100px; margin-top: 20px; text-align: center; }
        .progress-bar { width: 100%; height: 20px; background-color: #e9ecef; border-radius: 10px; overflow: hidden; margin-bottom: 10px; }
        .progress-fill { width: 0%; height: 100%; background-color: #28a745; transition: width 0.3s; }
        .status-label { font-size: 14px; color: #787878; }
    </style>
</head>
<body>

<h1>Price Comparer</h1>
<p class="subtitle">
    Drag your <b style="color:#28a745;">Reference Price File</b> on the left and <b style="color:#ff6b6b;">Location Files</b> on the right.<br>
    Compare price discrepancies across different inventory locations.
</p>

<div class="drop-container">
    <div id="ref-drop" class="drop-area">
        <h2>üîë Reference Price File</h2>
        <p>Drop the primary Excel file here (.xlsx, .xls)</p>
        <div class="file-list" id="ref-list"></div>
    </div>
    <div id="loc-drop" class="drop-area">
        <h2>üó∫Ô∏è Location Files</h2>
        <p>Drop multiple location Excel files here (.xlsx, .xls)</p>
        <div class="file-list" id="loc-list"></div>
    </div>
</div>

<button id="generate-btn" class="generate-btn" disabled>üìà Generate Price Report</button>

<div class="progress-container">
    <div class="progress-bar"><div class="progress-fill" id="progress-fill"></div></div>
    <div class="status-label" id="status-label">Ready to process files</div>
</div>

<script>
    const refDrop = document.getElementById('ref-drop');
    const locDrop = document.getElementById('loc-drop');
    const refList = document.getElementById('ref-list');
    const locList = document.getElementById('loc-list');
    const generateBtn = document.getElementById('generate-btn');
    const progressFill = document.getElementById('progress-fill');
    const statusLabel = document.getElementById('status-label');

    let referenceFile = null;
    let locationFiles = [];

    function updateGenerateButton() {
        generateBtn.disabled = !referenceFile || locationFiles.length === 0;
    }

    function createFileItem(file, list, isReference=false) {
        const div = document.createElement('div');
        div.className = 'file-item';
        div.textContent = (isReference ? 'üéØ ' : 'üìÑ ') + file.name.replace(/\.(xlsx|xls)$/i, '');
        const remove = document.createElement('span');
        remove.className = 'remove';
        remove.textContent = '‚úñ';
        remove.onclick = () => {
            list.removeChild(div);
            if(isReference) referenceFile = null;
            else locationFiles = locationFiles.filter(f => f !== file);
            updateGenerateButton();
        };
        div.appendChild(remove);
        list.appendChild(div);
    }

    function handleDrop(event, isReference=false) {
        event.preventDefault();
        const files = [...event.dataTransfer.files].filter(f => f.name.match(/\.(xlsx|xls)$/i));
        if(files.length === 0) return;

        if(isReference) {
            refList.innerHTML = '';
            referenceFile = files[0];
            createFileItem(referenceFile, refList, true);
        } else {
            files.forEach(f => {
                if(!locationFiles.includes(f)) {
                    locationFiles.push(f);
                    createFileItem(f, locList);
                }
            });
        }
        updateGenerateButton();
        event.target.classList.remove('dragover');
    }

    [refDrop, locDrop].forEach(dropArea => {
        dropArea.addEventListener('dragover', e => { e.preventDefault(); dropArea.classList.add('dragover'); });
        dropArea.addEventListener('dragleave', e => dropArea.classList.remove('dragover'));
    });

    refDrop.addEventListener('drop', e => handleDrop(e, true));
    locDrop.addEventListener('drop', e => handleDrop(e));

    generateBtn.addEventListener('click', async () => {
        if(!referenceFile || locationFiles.length === 0) return;

        const formData = new FormData();
        formData.append('referenceFile', referenceFile);
        locationFiles.forEach(f => formData.append('locationFiles', f));

        statusLabel.textContent = 'Processing price comparison... Please wait.';
        progressFill.style.width = '0%';

        try {
            const response = await fetch('http://localhost:8080/price/generatePrice', {
                method: 'POST',
                body: formData
            });

            const contentType = response.headers.get('Content-Type');

            if (contentType && (contentType.includes('application/json') || contentType.includes('text/plain'))) {
                const text = await response.text();
                throw new Error(text || 'Failed to generate report');
            }

            const blob = await response.blob();
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'Price_Report.xlsx';
            link.click();

            progressFill.style.width = '100%';
            statusLabel.textContent = '‚úÖ Price report generated successfully!';
        } catch (err) {
            console.error(err);
            statusLabel.textContent = '‚ùå Error occurred: ' + err.message;
            progressFill.style.width = '0%';
        }
    });
</script>
</body>
</html>
